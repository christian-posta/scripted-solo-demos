apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openai-openfga-policy
  namespace: enterprise-agentgateway
spec:
  parentRefs:
    - name: agentgateway
      namespace: enterprise-agentgateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /fga/openai
      backendRefs:
        - name: openai-all-models
          group: agentgateway.dev
          kind: AgentgatewayBackend
      timeouts:
        request: "120s"
---
apiVersion: v1
kind: Endpoints
metadata:
  name: openfga-policy
  namespace: enterprise-agentgateway
subsets:
- addresses:
  - ip: 192.168.65.254 # unfortunatley this needs to be an IP address :-/
  ports:
  - port: 7070
    protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: openfga-policy
  namespace: enterprise-agentgateway
spec:
  ports:
  - port: 7070
    targetPort: 7070
    protocol: TCP
---
apiVersion: enterpriseagentgateway.solo.io/v1alpha1
kind: EnterpriseAgentgatewayPolicy
metadata:
  name: openai-openfga-policy
  namespace: enterprise-agentgateway
  labels:
    app: agentgateway
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: openai-openfga-policy
  traffic:
    jwtAuthentication:
      mode: Optional
      providers:
        - issuer: http://localhost:8080/realms/mcp-realm
          audiences:
            - account
          jwks:
            remote:
              jwksPath: /realms/mcp-realm/protocol/openid-connect/certs
              backendRef:
                name: keycloak-jwks
                kind: AgentgatewayBackend
                group: agentgateway.dev
                port: 8080
    extAuth:
      backendRef:
        name: openfga-policy
        namespace: enterprise-agentgateway
        kind: Service
        port: 7070
      grpc:
        contextExtensions:
          environment: "development"
          region: "us-west-1"
          service: "agentgateway"
      forwardBody:
        maxSize: 8192  # maxRequestBytes: 8192
        # Note: allowPartialMessage and packAsBytes are not directly supported
        # The forwardBody.maxSize handles the maxRequestBytes equivalent        
