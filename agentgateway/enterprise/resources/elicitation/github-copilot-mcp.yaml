apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: github-copilot-mcp
  namespace: enterprise-agentgateway
spec:
  parentRefs:
  - name: agentgateway
  rules:
    - matches:
        - path:
            type: Exact
            value: /github-copilot/mcp  
        - path:
            type: Exact
            value: /.well-known/oauth-protected-resource/github-copilot/mcp  
        - path:
            type: Exact
            value: /.well-known/oauth-authorization-server/github-copilot/mcp                          
      backendRefs:
      - name: github-copilot-mcp-backend
        group: agentgateway.dev
        kind: AgentgatewayBackend
---
# MCP Backend with multiple targets
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: github-copilot-mcp-backend
  namespace: enterprise-agentgateway
spec:
  mcp:
    targets:
      - name: github-copilot
        static:
          host: api.githubcopilot.com
          port: 443
          path: /mcp/
          protocol: StreamableHTTP  # Explicitly set protocol
          policies:
            tls: {}       
---
# Policy for CORS, header modification, and backend TLS
apiVersion: enterpriseagentgateway.solo.io/v1alpha1
kind: EnterpriseAgentgatewayPolicy
metadata:
  name: github-copilot-mcp-token-exchange-policy
  namespace: enterprise-agentgateway
spec:
  targetRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: github-copilot-mcp-backend 
  backend:
    tokenExchange: {}  
---
apiVersion: enterpriseagentgateway.solo.io/v1alpha1
kind: EnterpriseAgentgatewayPolicy
metadata:
  name: github-copilot-mcp-policy
  namespace: enterprise-agentgateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: github-copilot-mcp
  traffic:                           
    cors:
      allowOrigins:
        - "*"
      allowHeaders:
        - "*"
      allowMethods:
        - "*"
      allowCredentials: false
    headerModifiers:
      request:
        remove:
          - x-forwarded-for
          - x-forwarded-host
          - x-forwarded-proto
