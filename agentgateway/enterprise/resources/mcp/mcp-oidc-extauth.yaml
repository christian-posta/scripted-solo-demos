apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-oidc-extauth
  namespace: enterprise-agentgateway
spec:
  parentRefs:
  - name: agentgateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /oidc/mcp  
      backendRefs:
      - name: public-mcp-backend
        group: agentgateway.dev
        kind: AgentgatewayBackend
---
apiVersion: v1
kind: Secret
metadata:
  name: auth0-oauth-secret
  namespace: enterprise-agentgateway
type: extauth.solo.io/oauth
stringData:
  client-secret: $AUTH0_CLIENT_SECRET
---
apiVersion: extauth.solo.io/v1
kind: AuthConfig
metadata:
  name: mcp-oidc
  namespace: enterprise-agentgateway
spec:
  configs:
  - oauth2:
      oidcAuthorizationCode:
        
        clientId: "J481ZkVndz8g9dxD6nDGC4XG2zhGTUIQ"
        
        # Reference to the secret containing the client secret
        clientSecretRef:
          name: auth0-oauth-secret
          namespace: enterprise-agentgateway
        
        # Issuer URL (ExtAuth uses this for OIDC discovery)
        issuerUrl: "https://ceposta-solo.auth0.com/"
        
        # Public URL where your app is accessible
        appUrl: "http://localhost:3000"
        
        callbackPath: "/oidc/mcp/callback"
        
        # Logout path (optional)
        logoutPath: "/oidc/mcp/logout"
        
        # Scopes to request
        scopes:
        - openid
        
        # Headers to add to requests after successful auth
        headers:
          idTokenHeader: X-Id-Token
          accessTokenHeader: X-Access-Token
        
        # Extract claims to headers
        identityToken:
          claimsToHeaders:
          - claim: email
            header: X-User-Email
          - claim: sub
            header: X-User-Id
          - claim: realm_access
            header: X-Realm-Access
---
# Policy for CORS, header modification, and backend TLS
apiVersion: enterpriseagentgateway.solo.io/v1alpha1
kind: EnterpriseAgentgatewayPolicy
metadata:
  name: mcp-oidc-extauth-policy
  namespace: enterprise-agentgateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-oidc-extauth
  backend:
    tls: {}  # Enables TLS for backend connections
  traffic:
    entExtAuth:
      authConfigRef:
        name: mcp-oidc
        namespace: enterprise-agentgateway  
    cors:
      allowOrigins:
        - "*"
      allowHeaders:
        - "*"
      allowMethods:
        - "*"
      allowCredentials: false
    headerModifiers:
      request:
        remove:
          - x-forwarded-for
          - x-forwarded-host
          - x-forwarded-proto
