# OpenFGA Authorization Demo

This directory contains the OpenFGA implementation for fine-grained access control in the AI Gateway.

## Overview

This demo implements fine-grained authorization (ReBAC) for an AI Gateway using OpenFGA. It demonstrates:

- **Team-based access control**: Users belong to teams with different subscriptions
- **Model access control**: Models are tied to providers and subscriptions
- **Feature-based access**: Models have specific features (vision, code generation, etc.)
- **Project-based access**: Users have roles (owner, contributor) on projects
- **Budget constraints**: Projects have budgets that limit model usage

## Architecture

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   Teams    │────▶│ Subscriptions│────▶│  Providers  │
└─────────────┘     └──────────────┘     └─────────────┘
       │                     │                   │
       ▼                     ▼                   ▼
  ┌────────┐          ┌───────────┐       ┌──────────┐
  │  Users │          │ Providers │       │  Models  │◀──┐
  └────────┘          └───────────┘       └──────────┘   │
       │                                                │
       │                                        ┌───────────┐
       └─────────────────▶┬───────────────▶│ Projects  │
                          │                   └───────────┘
                    ┌─────────────┐                │
                    │   Features  │◀───────────────┘
                    └─────────────┘
```

## Files

- `authorization-model.json`: The OpenFGA authorization model defining all types and relationships
- `relationships.py`: Python class to interact with OpenFGA
- `test-relationships.py`: Demo script to test relationships (deprecated, use `run-tests.py`)
- `docker-compose.yaml`: Docker configuration for OpenFGA server
- `setup-openfga.sh`: Automated setup script
- `run-tests.py`: Test runner (generated by setup script)
- `server.py`: gRPC server for external authorization (not used in this demo)

## Prerequisites

1. **Docker**: For running the OpenFGA server
2. **Python 3.8+**: For running the demo
3. **OpenFGA CLI**: For creating stores and uploading models

### Installing OpenFGA CLI

**macOS:**
```bash
brew install openfga/tap/fga
```

**Other platforms:**
See: https://github.com/openfga/cli

## Quick Start

To use the playground use the online one: `https://play.fga.dev/sandbox/?store=FooStore`
The local one won't work well in Docker.

### 1. Install Python Dependencies

```bash
pip install -r ../../requirements.txt
```

This installs `openfga-sdk` and other dependencies.

### 2. Run the Setup Script

```bash
cd policy/openfga
./setup-openfga.sh
```

This script will:
1. Start the OpenFGA Docker server
2. Create a new store
3. Upload the authorization model
4. Generate a test runner script
5. Print the Store ID and Model ID

### 3. Run Tests

Note, we should always do this, because this is what sets up the tuples!!

```bash
 source .env && python test-relationships.py
```

If this looks good, we should copy the .env file that gets created (with the model/store ID) over to where the ext-auth server is:

```bash
cp .env ~/go/src/github.com/christian-posta/extauth-policy-engine
```

Then we can start the ext_auth server (go to that dir):

```bash
cd ~/go/src/github.com/christian-posta/extauth-policy-engine
source .env
./policy-engine
```

NOTE: Check that the startup prints the store and model id you are expecting!!!

Then start up agentgateway. Then you can call it according to the README.md at the root of the project. At the moment we need to user the agentgateway from the dynamic metadata hack branch:

> https://github.com/howardjohn/agentgateway/tree/extauth/dynamic-meta-hack

Once we sort this out correctly, we can just use a regular build.

```bash
cargo run -- -f ~/scripted-demos/agentgateway/config/agentgateway_config.yaml
```


## Stopping the Server

```bash
docker-compose down
```


## References

- [OpenFGA Documentation](https://openfga.dev/docs)
- [OpenFGA Python SDK](https://github.com/openfga/python-sdk)
- [OpenFGA CLI](https://github.com/openfga/cli)
- [Zanzibar Paper](https://research.google/pubs/zanzibar/)

