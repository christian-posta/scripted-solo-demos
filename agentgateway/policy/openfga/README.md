# OpenFGA Authorization Demo

This directory contains the OpenFGA implementation for fine-grained access control in the AI Gateway.

## Overview

This demo implements fine-grained authorization (ReBAC) for an AI Gateway using OpenFGA. It demonstrates:

- **Team-based access control**: Users belong to teams with different subscriptions
- **Model access control**: Models are tied to providers and subscriptions
- **Feature-based access**: Models have specific features (vision, code generation, etc.)
- **Project-based access**: Users have roles (owner, contributor) on projects
- **Budget constraints**: Projects have budgets that limit model usage

## Architecture

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   Teams    │────▶│ Subscriptions│────▶│  Providers  │
└─────────────┘     └──────────────┘     └─────────────┘
       │                     │                   │
       ▼                     ▼                   ▼
  ┌────────┐          ┌───────────┐       ┌──────────┐
  │  Users │          │ Providers │       │  Models  │◀──┐
  └────────┘          └───────────┘       └──────────┘   │
       │                                                │
       │                                        ┌───────────┐
       └─────────────────▶┬───────────────▶│ Projects  │
                          │                   └───────────┘
                    ┌─────────────┐                │
                    │   Features  │◀───────────────┘
                    └─────────────┘
```

## Files

- `authorization-model.json`: The OpenFGA authorization model defining all types and relationships
- `relationships.py`: Python class to interact with OpenFGA
- `test-relationships.py`: Demo script to test relationships (deprecated, use `run-tests.py`)
- `docker-compose.yaml`: Docker configuration for OpenFGA server
- `setup-openfga.sh`: Automated setup script
- `run-tests.py`: Test runner (generated by setup script)
- `server.py`: gRPC server for external authorization (not used in this demo)

## Prerequisites

1. **Docker**: For running the OpenFGA server
2. **Python 3.8+**: For running the demo
3. **OpenFGA CLI**: For creating stores and uploading models

### Installing OpenFGA CLI

**macOS:**
```bash
brew install openfga/tap/fga
```

**Other platforms:**
See: https://github.com/openfga/cli

## Quick Start

### 1. Install Python Dependencies

```bash
pip install -r ../../requirements.txt
```

This installs `openfga-sdk` and other dependencies.

### 2. Run the Setup Script

```bash
cd policy/openfga
./setup-openfga.sh
```

This script will:
1. Start the OpenFGA Docker server
2. Create a new store
3. Upload the authorization model
4. Generate a test runner script
5. Print the Store ID and Model ID

### 3. Run Tests

```bash
# Using the generated script
python run-tests.py <STORE_ID> <MODEL_ID>

# Or set environment variables
export FGA_STORE_ID=<store_id>
export FGA_MODEL_ID=<model_id>
python run-tests.py
```

The output will show:
- ✅ Alice can access Claude 3 Opus (via research team subscription)
- ❌ Alice cannot access Gemini Pro (not in subscription)
- ✅ Bob can access GPT-4 (via dev team subscription)
- ✅ Bob can access Claude 3 Opus (as contributor on nlp_research project)
- ✅ Alice can use vision features
- ❌ Alice cannot use code_generation features
- ✅ Alice can afford small token usage
- ❌ Alice cannot afford large token usage (exceeds budget)

## Manual Setup

If you prefer to set things up manually:

### 1. Start OpenFGA Server

```bash
docker-compose up -d
```

### 2. Create a Store

```bash
fga store create --name "AI Gateway ReBAC"
# Note the store ID from the output
```

### 3. Upload Authorization Model

```bash
fga model write --store-id <STORE_ID> --file authorization-model.json
# Note the model ID from the output
```

### 4. Run Tests

```bash
export FGA_STORE_ID=<store_id>
export FGA_MODEL_ID=<model_id>
python run-tests.py
```

## Using in Your Application

Here's how to use the `AIGatewayReBAC` class in your application:

```python
import asyncio
from relationships import AIGatewayReBAC

async def check_access(user_id, model_id):
    gateway = AIGatewayReBAC(
        api_url="http://localhost:8181",
        store_id="your_store_id",
        model_id="your_model_id"
    )
    
    # Check if user can access the model
    can_access = await gateway.can_access_model(user_id, model_id)
    
    # Check if user can afford the request
    can_afford = await gateway.can_afford_model(user_id, model_id, token_count=1000)
    
    return can_access and can_afford

# Usage
result = asyncio.run(check_access("alice", "claude-3-opus"))
```

## Stopping the Server

```bash
docker-compose down
```

## Authorization Model

The authorization model defines:

### Types
- **user**: Individual users
- **team**: Groups of users
- **subscription**: Team subscriptions to providers
- **provider**: AI model providers (Anthropic, OpenAI, Google)
- **model**: Specific AI models (Claude 3 Opus, GPT-4, etc.)
- **feature**: Model features (vision, code generation, etc.)
- **project**: User projects with budgets

### Key Relations

- `team:member` → users who belong to a team
- `subscription:subscriber` → team that has the subscription
- `subscription:offers` → providers offered by the subscription
- `project:owner` → user who owns a project
- `project:contributor` → users who can contribute
- `model:provider` → provider that owns a model
- `model:can_use` → users who can use a model (computed)
- `project:allowed_model` → models allowed on a project

## How It Works

1. **User** → belongs to **Team** (via membership)
2. **Team** → has **Subscription** (via subscriber relation)
3. **Subscription** → offers **Provider** (via offers relation)
4. **Provider** → owns **Model** (via provider relation)
5. Users can use models if:
   - Their team's subscription offers the provider, OR
   - They are owner/contributor of a project that allows the model

### Example: Alice accessing Claude 3 Opus

1. Alice is a member of research_team
2. research_team has subscription:academic
3. subscription:academic offers provider:anthropic
4. provider:anthropic provides model:claude-3-opus
5. Therefore: Alice can use Claude 3 Opus ✅

## Development

### Adding New Relationships

Edit `relationships.py` to add new relationship methods or modify `setup_demo_relationships()` to add test data.

### Modifying the Authorization Model

Edit `authorization-model.json` and re-upload:

```bash
fga model write --store-id <STORE_ID> --file authorization-model.json
```

## Troubleshooting

### "Could not connect to OpenFGA"

- Check that Docker is running: `docker ps`
- Check that OpenFGA is up: `curl http://localhost:8181/healthz`

### "Store not found"

- Verify the store ID with: `fga store list`
- Create a new store: `fga store create --name "My Store"`

### "Model not found"

- Check the model ID with: `fga model list --store-id <STORE_ID>`
- Re-upload the model: `fga model write --store-id <STORE_ID> --file authorization-model.json`

## References

- [OpenFGA Documentation](https://openfga.dev/docs)
- [OpenFGA Python SDK](https://github.com/openfga/python-sdk)
- [OpenFGA CLI](https://github.com/openfga/cli)
- [Zanzibar Paper](https://research.google/pubs/zanzibar/)

